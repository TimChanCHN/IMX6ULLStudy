# 4.中断
## 1. Cortex-A7中断系统
1. 中断向量表
   1. ARM芯片从0X00000000开始运行，执行指令。在程序开始的地方存放着中断向量表。中断向量表主要功能是描述中断对应的中断服务函数。Cortex-A中断向量表有8个中断，其中重点关注IRQ。Cortex-A的中断向量表需要用户自己去定义。
   2. 中断向量表其实就是一个函数数组，该数组存放着不同中断类型对应的函数入口地址。
   3. 对于ARM而言，中断向量表为8个并不意味着不够用，因为对于开发者而言，常用的比如外部中断、定时器中断等中断，都是在中断向量表中的IRQ中，在IRQ的中断服务函数里面，只要得到中断号，就可以判断出当前是哪个中断出现。
   4. 中断号可以通过查询"IMX6ULL参考手册Table3-1"，同样也可以移植好NXP的官方SDK，即可以查看中断号(对该表中的ID加上32就是实际的中断号，因为前32个中断号是私有的）。

2. 中断向量偏移
   1. 如果代码不是在0x00000000开始执行，在0x87800000开始执行的话，中断向量表的设置也应该是在该地址上面编写，因此该地址就是中断向量偏移。
   2. 像特定寄存器写入中断向量偏移，即可以避免中断向量表和运行地址不对应的问题。
   3. 可以在C函数中使用宏定义`__set_VBAR`对中断向量偏移进行设置。
   
3. 中断控制器
   1. 如同其他单片机一样，都会有一个中断控制器，用于管理特定中断的开关、优先级等等。

4. 中断服务程序的编写
   1. IRQ中断服务函数的编写；--侧重于IRQ中断服务函数，在start.s中实现
   2. IRQ中断服务函数里面去查找并运行具体的外设中断服务函数。--侧重于外部中断服务函数，是具体外设触发中断时要处理的内容

## 2. 中断服务程序的编写
1. reset中断
   1. 关闭I,D Cache和MMU
   2. 设置处理器9中工作模式下对应的SP指针。要使用中断那么必须设置IRQ模式下的SP指针【即是不同模式下都有自己的栈空间】
   3. 清BSS段
   4. 跳去main函数
   5. 例子：具体设置见例程的start.s
   
2. IRQ中断
   1. 如1.5所属，中断服务程序包括了中断服务函数（start.s)和外设中断服务函数（.c）两部分。其中中断服务函数主要是用于保存现场，获取中断号，跳进外设中断服务函数；而外设中断服务函数则是用于处理专门的中断事务。
   2. 通过指令`mrc p15, 4, r1, c15, c0, 0`读取CP15的CBAR寄存器，该寄存器保存了GIC(中断)控制器的首地址，GIC寄存器组偏移0x1000~0x1fff为GIC的分发器。0x2000~0x3fff为CPU接口端根据这一点来对中断控制器进行访问。
   3. 在start.s中，R1寄存器保存着GIC控制器的CPU接口端基地址,读取CPU接口段的GICC_IAR寄存器的值保存到R0寄存器里面。因为可以从GICC_IAR的bit9~0读取中断ID，而r0(即中断ID)则作为参数送到中断处理函数。【C函数的参数，分别对应着寄存器r0, r1,....】
   4. system_irqhandler处理完具体的中断以后，需要将对应的中断ID值写入到GICC_EOIR寄存器里面
   5. 在Linux中可以看到有些外设中断服务函数是可以传参的，而此处的中断服务程序只有一个参数，那就是中断号。其实在C函数中，可以做如此处理，设置一个结构体数组，其中结构体包含了外设中断服务函数(该服务函数包含中断号以及参数)以及需要传递的参数，在start.s调用中断服务函数1的时候，中断服务函数1又会调用该结构体里面的中断服务函数，至于参数，则由该结构体传递过去即可。具体实现请见例程。

## 3. 外设中断应用
### 1. 定时器中断
1. 6ULL定时器EPIT
   1. EPIT是32位的一个向下计数器
   2. 可以对时钟源进行分频，12位的分频器，0~4095分别代表1~4096分频
   3. 开启定时器以后，计数寄存器会每个时钟减1，如果和比较寄存器里面的值相等的话就会触发中断
   4. 两种工作模式：Set-add-forget(预加载功能)，一个是free-runing(启动后自动倒计时)
   
### 2. 利用定时器消抖
1. 原理：当按下中断时，触发定时器，当定时时间到，触发定时器中断时，在定时器中断中判断按键值是否为0，是则可以认为按键已经稳定按下，此时的按键值是一个有效的按键结果。

### 3.GPT定时器
1. 该定时其不同于EPIT，EPIT只是一个向下计数器，而GPT可以设置成向上计数、向下计数、捕获等功能。
2. GPT定时器的设置类似EPIT，详情请见例程代码9.
3. 由于GPT有向上计数功能，把它设置成向上计数后，每次计数会占用一定的时间，通过对该计数值的统计，可以实现高精度延时。这就是高精度延时的原理--对GPT计数器的计数值进行统计。